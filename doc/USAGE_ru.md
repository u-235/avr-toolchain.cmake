[EN]

----------------


## Необходимый минимум

Для сборки проекта с AVR достаточно указать в переменной `CMAKE_TOOLCHAIN_FILE` путь к `avr-gcc-toolchain.cmake`. Это нужно сделать или с помощью ключа `-D` при вызове `cmake` или в файле `CMakePresets.json`.

Модуль `avr-gcc-toolchain.cmake` делает следующее:

- Указывает CMake использовать платформу Generic и процессор AVR.
- Указывает CMake использовать компиляторы avr-gcc и avr-g++.
- Отменяет все флаги компилятора и линковщика для известных типов сборки (`Debug`, `Release`, `RelWithDebInfo` и `MinSizeRel`). Флаги по умолчанию так же сбрасываются.
- Пытается найти исполняемую библиотеку `lto_plugin` и если находит, то добавляет этот плагин к вызовам архиватора.
- Добавляет к переменной `CMAKE_MODULE_PATH` путь с папкой `./module`


## Модуль FindAVR

Модуль FindAVR предоставляет дополнительные возможности, такие как создание и конфигурирование интерфейсной цели для микроконтроллера или получение прошивки из `elf`. Что бы использовать эти возможности, добавьте в главном `CMakeLists.txt`

```cmake
find_package(AVR REQUIRED binutils libc)
```


## Команды


### avr_create_mcu

Создает интерфейсную цель для МК.

```cmake
avr_create_mcu(
    mcu
    [NAME name]
)
```

**Параметры**

- `mcu` Указывает тип МК. Также указывает имя цели, если `NAME` не определено.
- `NAME name` Необязательный параметр, указывает имя цели.

--------------------------------


### avr_configure_mcu

Конфигурирует МК.

```cmake
avr_configure_mcu(
    mcu
    [NAME name]
    [DEFINES <name | name=value> [...]]
    [OPTIONS option [...]]
    [LINK_OPTIONS option [...]]
)
```

Если указанной цели не существует, функция создает цель при помощи `avr_create_mcu`.

**Параметры**

- `mcu` Указывает тип МК. Также указывает имя цели, если `NAME` не определено.
- `NAME name` Необязательный параметр, указывает имя цели.
- `DEFINES <name | name=value>` Необязательный параметр, добавляет определения, передаваемые компилятору с ключами `-D`.
- `OPTIONS option` Необязательный параметр, добавляет опции, передаваемые компилятору.
- `LINK_OPTIONS option` Необязательный параметр, добавляет опции, передаваемые линковщику.

**Пример**

```cmake
avr_configure_mcu(
    atmega168
    NAME MAIN_MCU
    DEFINES      F_CPU=16000000
    OPTIONS      -Os -ffunction-sections -fdata-sections
    LINK_OPTIONS -Wl,--gc-sections
)
```

--------------------------------


### avr_print_size

Выводит информацию об использовании памяти.

```
avr_print_size(
    target
)
```

**Параметры**

- `target` Задает цель. Цель должна быть создана с помощью команды
  `add_executable`.

--------------------------------


### avr_get_firmware

Получение прошивки flash и EEPROM.

```
avr_get_firmware(
    target
)
```

Функция извлекает прошивки flash и EEPROM из цели и сохраняет их в файлах `${target}-flash.hex` и `${target}-eeprom.hex` соответственно. В настоящее время в качестве выходного формата поддерживается только `ihex`.

**Параметры**

- `target` Задает цель. Цель должна быть создана с помощью команды `add_executable`.

--------------------------------


[EN]: ../USAGE.md
